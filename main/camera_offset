local Env = getgenv and getgenv() or _G

if Env.TPO_SCRIPT_INSTANCE and typeof(Env.TPO_SCRIPT_INSTANCE.Cleanup) == "function" then
    Env.TPO_SCRIPT_INSTANCE:Cleanup()
    task.wait(0.1)
end

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

if not Camera then return end

local isEnabled = false
local RENDER_ID = "Vantality_CameraOffset"

local offsetSettings = {
    X = 1.5, 
    Y = 0,   
    Z = 0    
}

local TpoController = {}

local function updateOffset()
    if not Camera or not isEnabled then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local head = character:FindFirstChild("Head")
    if not head then return end

    local currentCFrame = Camera.CFrame
    if (head.Position - currentCFrame.Position).Magnitude < 1 then
        return 
    end

    Camera.CFrame = currentCFrame * CFrame.new(offsetSettings.X, offsetSettings.Y, offsetSettings.Z)
end

function TpoController:enable()
    if isEnabled then return end
    isEnabled = true
    
    RunService:UnbindFromRenderStep(RENDER_ID)
    RunService:BindToRenderStep(RENDER_ID, Enum.RenderPriority.Camera.Value + 1, updateOffset)
end

function TpoController:disable()
    if not isEnabled then return end
    isEnabled = false
    RunService:UnbindFromRenderStep(RENDER_ID)
end

function TpoController:updateOffset(axis, value)
    local numValue = tonumber(value)
    if not numValue then return end
    if offsetSettings[axis] ~= nil then
        offsetSettings[axis] = numValue
    end
end

local cleanupFunction = function()
    isEnabled = false
    RunService:UnbindFromRenderStep(RENDER_ID)
    if Env.TPO == TpoController then Env.TPO = nil end
    Env.TPO_SCRIPT_INSTANCE = nil
end

Env.TPO = TpoController
Env.TPO_SCRIPT_INSTANCE = { Cleanup = cleanupFunction }
