local Lighting = game:GetService("Lighting")
local Terrain = workspace:WaitForChild("Terrain")
local Env = getgenv and getgenv() or _G

if Env.SkyManager then
	Env.SkyManager:Disable()
	Env.SkyManager = nil
end

local Manager = {
	IsActive = false,
	Settings = {
		SunSize = 11,
		SunIntensity = 0.25,
		SunSpread = 0.1,
		MoonSize = 11,
		StarCount = 3000,
		CloudCover = 0.5,
		CloudDensity = 0.7,
		CloudColor = Color3.fromRGB(255, 255, 255)
	}
}

local Storage = {
	Old = { Sky = nil, Clouds = nil, SunRays = nil },
	Custom = { Sky = nil, Clouds = nil, SunRays = nil }
}

local function ApplyProperties()
	if not Manager.IsActive then return end

	local S = Manager.Settings
	local C = Storage.Custom

	if C.Sky then
		C.Sky.SunAngularSize = S.SunSize
		C.Sky.MoonAngularSize = S.MoonSize
		C.Sky.StarCount = S.StarCount
	end

	if C.SunRays then
		C.SunRays.Intensity = S.SunIntensity
		C.SunRays.Spread = S.SunSpread
		C.SunRays.Enabled = true
	end

	if C.Clouds then
		C.Clouds.Cover = S.CloudCover
		C.Clouds.Density = S.CloudDensity
		C.Clouds.Color = S.CloudColor
		C.Clouds.Enabled = true
	end
end

function Manager:Enable()
	if self.IsActive then return end
	self.IsActive = true

	local oldSky = Lighting:FindFirstChildOfClass("Sky")
	if oldSky and oldSky.Name ~= "VantalitySky" then
		Storage.Old.Sky = oldSky
		oldSky.Parent = nil
	end

	local oldClouds = Terrain:FindFirstChildOfClass("Clouds") or Lighting:FindFirstChildOfClass("Clouds")
	if oldClouds and oldClouds.Name ~= "VantalityClouds" then
		Storage.Old.Clouds = oldClouds
		oldClouds.Parent = nil
	end

	local oldRays = Lighting:FindFirstChildOfClass("SunRaysEffect")
	if oldRays and oldRays.Name ~= "VantalitySunRays" then
		Storage.Old.SunRays = oldRays
		oldRays.Parent = nil
	end

	local newSky = Instance.new("Sky")
	newSky.Name = "VantalitySky"
	newSky.SkyboxBk = "rbxassetid://1"
	newSky.SkyboxDn = "rbxassetid://1"
	newSky.SkyboxFt = "rbxassetid://1"
	newSky.SkyboxLf = "rbxassetid://1"
	newSky.SkyboxRt = "rbxassetid://1"
	newSky.SkyboxUp = "rbxassetid://1"
	if Storage.Old.Sky then -- Копируем текстуры старого неба, чтобы не было черноты
		newSky.SkyboxBk = Storage.Old.Sky.SkyboxBk
		newSky.SkyboxDn = Storage.Old.Sky.SkyboxDn
		newSky.SkyboxFt = Storage.Old.Sky.SkyboxFt
		newSky.SkyboxLf = Storage.Old.Sky.SkyboxLf
		newSky.SkyboxRt = Storage.Old.Sky.SkyboxRt
		newSky.SkyboxUp = Storage.Old.Sky.SkyboxUp
	end
	newSky.Parent = Lighting
	Storage.Custom.Sky = newSky

	local newClouds = Instance.new("Clouds")
	newClouds.Name = "VantalityClouds"
	newClouds.Parent = Terrain
	Storage.Custom.Clouds = newClouds

	local newRays = Instance.new("SunRaysEffect")
	newRays.Name = "VantalitySunRays"
	newRays.Parent = Lighting
	Storage.Custom.SunRays = newRays

	ApplyProperties()
end

function Manager:Disable()
	if not self.IsActive then return end
	self.IsActive = false

	if Storage.Custom.Sky then Storage.Custom.Sky:Destroy() Storage.Custom.Sky = nil end
	if Storage.Custom.Clouds then Storage.Custom.Clouds:Destroy() Storage.Custom.Clouds = nil end
	if Storage.Custom.SunRays then Storage.Custom.SunRays:Destroy() Storage.Custom.SunRays = nil end

	if Storage.Old.Sky then Storage.Old.Sky.Parent = Lighting Storage.Old.Sky = nil end
	if Storage.Old.Clouds then Storage.Old.Clouds.Parent = Terrain Storage.Old.Clouds = nil end
	if Storage.Old.SunRays then Storage.Old.SunRays.Parent = Lighting Storage.Old.SunRays = nil end
end

function Manager:SetSun(size, intensity, spread)
	if size then self.Settings.SunSize = size end
	if intensity then self.Settings.SunIntensity = intensity end
	if spread then self.Settings.SunSpread = spread end
	ApplyProperties()
end

function Manager:SetMoon(size)
	if size then self.Settings.MoonSize = size end
	ApplyProperties()
end

function Manager:SetStars(count)
	if count then self.Settings.StarCount = count end
	ApplyProperties()
end

function Manager:SetClouds(cover, density, color)
	if cover then self.Settings.CloudCover = cover end
	if density then self.Settings.CloudDensity = density end
	if color then self.Settings.CloudColor = color end
	ApplyProperties()
end

Env.SkyManager = Manager
