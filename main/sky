local Lighting = game:GetService("Lighting")
local Terrain = workspace:WaitForChild("Terrain")

if _G.SkyManager then
	_G.SkyManager:Disable()
end

local Manager = {}
local Cache = {
	Sky = nil,
	SunRays = nil,
	Clouds = nil,
	CreatedSky = false,
	CreatedSunRays = false,
	CreatedClouds = false,
	Defaults = {}
}

local function GetSky()
	local sky = Lighting:FindFirstChildOfClass("Sky")
	if not sky then
		sky = Instance.new("Sky")
		sky.Name = "CustomSky"
		sky.Parent = Lighting
		Cache.CreatedSky = true
	else
		Cache.Defaults.SunAngularSize = sky.SunAngularSize
		Cache.Defaults.MoonAngularSize = sky.MoonAngularSize
		Cache.Defaults.StarCount = sky.StarCount
	end
	Cache.Sky = sky
	return sky
end

local function GetSunRays()
	local rays = Lighting:FindFirstChildOfClass("SunRaysEffect")
	if not rays then
		rays = Instance.new("SunRaysEffect")
		rays.Name = "CustomSunRays"
		rays.Parent = Lighting
		Cache.CreatedSunRays = true
	else
		Cache.Defaults.SunRaysIntensity = rays.Intensity
		Cache.Defaults.SunRaysSpread = rays.Spread
		Cache.Defaults.SunRaysEnabled = rays.Enabled
	end
	Cache.SunRays = rays
	return rays
end

local function GetClouds()
	local clouds = Terrain:FindFirstChildOfClass("Clouds") or Lighting:FindFirstChildOfClass("Clouds")
	if not clouds then
		clouds = Instance.new("Clouds")
		clouds.Name = "CustomClouds"
		clouds.Parent = Terrain
		Cache.CreatedClouds = true
	else
		Cache.Defaults.CloudCover = clouds.Cover
		Cache.Defaults.CloudDensity = clouds.Density
		Cache.Defaults.CloudColor = clouds.Color
		Cache.Defaults.CloudEnabled = clouds.Enabled
	end
	Cache.Clouds = clouds
	return clouds
end

function Manager:SetSun(size, rayIntensity, raySpread)
	local sky = GetSky()
	local rays = GetSunRays()
	
	if size then sky.SunAngularSize = size end
	
	if rayIntensity or raySpread then
		rays.Enabled = true
		if rayIntensity then rays.Intensity = rayIntensity end
		if raySpread then rays.Spread = raySpread end
	end
end

function Manager:SetMoon(size)
	local sky = GetSky()
	if size then sky.MoonAngularSize = size end
end

function Manager:SetStars(count)
	local sky = GetSky()
	if count then sky.StarCount = count end
end

function Manager:SetClouds(cover, density, color)
	local clouds = GetClouds()
	clouds.Enabled = true
	if cover then clouds.Cover = cover end
	if density then clouds.Density = density end
	if color then clouds.Color = color end
end

function Manager:Disable()
	if Cache.Sky then
		if Cache.CreatedSky then
			Cache.Sky:Destroy()
		else
			Cache.Sky.SunAngularSize = Cache.Defaults.SunAngularSize or 11
			Cache.Sky.MoonAngularSize = Cache.Defaults.MoonAngularSize or 11
			Cache.Sky.StarCount = Cache.Defaults.StarCount or 3000
		end
	end

	if Cache.SunRays then
		if Cache.CreatedSunRays then
			Cache.SunRays:Destroy()
		else
			Cache.SunRays.Intensity = Cache.Defaults.SunRaysIntensity or 0
			Cache.SunRays.Spread = Cache.Defaults.SunRaysSpread or 0.1
			Cache.SunRays.Enabled = Cache.Defaults.SunRaysEnabled
		end
	end

	if Cache.Clouds then
		if Cache.CreatedClouds then
			Cache.Clouds:Destroy()
		else
			Cache.Clouds.Cover = Cache.Defaults.CloudCover or 0.5
			Cache.Clouds.Density = Cache.Defaults.CloudDensity or 0.7
			Cache.Clouds.Color = Cache.Defaults.CloudColor or Color3.fromRGB(255, 255, 255)
			Cache.Clouds.Enabled = Cache.Defaults.CloudEnabled
		end
	end

	_G.SkyManager = nil
end

GetSky()
GetSunRays()
GetClouds()

_G.SkyManager = Manager
