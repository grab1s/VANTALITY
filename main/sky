local Lighting = game:GetService("Lighting")
local Terrain = workspace:WaitForChild("Terrain")
local Env = getgenv and getgenv() or _G

if Env.SkyManager then
	Env.SkyManager:Disable()
end

local Manager = {}
local Storage = {
	OldSky = nil,
	OldClouds = nil,
	OldSunRays = nil,
	ActiveSky = nil,
	ActiveClouds = nil,
	ActiveSunRays = nil
}

local function CreateSky()
	if Storage.ActiveSky then return Storage.ActiveSky end
	
	local oldSky = Lighting:FindFirstChildOfClass("Sky")
	if oldSky and oldSky.Name ~= "VantalitySky" then
		Storage.OldSky = oldSky
		oldSky.Parent = nil
	end

	local sky = Instance.new("Sky")
	sky.Name = "VantalitySky"
	sky.SkyboxBk = "rbxassetid://1" 
	sky.SkyboxDn = "rbxassetid://1"
	sky.SkyboxFt = "rbxassetid://1"
	sky.SkyboxLf = "rbxassetid://1"
	sky.SkyboxRt = "rbxassetid://1"
	sky.SkyboxUp = "rbxassetid://1"
	sky.StarCount = 3000
	sky.SunAngularSize = 11
	sky.MoonAngularSize = 11
	
	if Storage.OldSky then
		sky.SkyboxBk = Storage.OldSky.SkyboxBk
		sky.SkyboxDn = Storage.OldSky.SkyboxDn
		sky.SkyboxFt = Storage.OldSky.SkyboxFt
		sky.SkyboxLf = Storage.OldSky.SkyboxLf
		sky.SkyboxRt = Storage.OldSky.SkyboxRt
		sky.SkyboxUp = Storage.OldSky.SkyboxUp
	end
	
	sky.Parent = Lighting
	Storage.ActiveSky = sky
	return sky
end

local function CreateClouds()
	if Storage.ActiveClouds then return Storage.ActiveClouds end

	local oldClouds = Terrain:FindFirstChildOfClass("Clouds") or Lighting:FindFirstChildOfClass("Clouds")
	if oldClouds and oldClouds.Name ~= "VantalityClouds" then
		Storage.OldClouds = oldClouds
		oldClouds.Parent = nil
	end

	local clouds = Instance.new("Clouds")
	clouds.Name = "VantalityClouds"
	clouds.Cover = 0.5
	clouds.Density = 0.7
	clouds.Parent = Terrain
	Storage.ActiveClouds = clouds
	return clouds
end

local function CreateSunRays()
	if Storage.ActiveSunRays then return Storage.ActiveSunRays end

	local oldRays = Lighting:FindFirstChildOfClass("SunRaysEffect")
	if oldRays and oldRays.Name ~= "VantalitySunRays" then
		Storage.OldSunRays = oldRays
		oldRays.Parent = nil
	end

	local rays = Instance.new("SunRaysEffect")
	rays.Name = "VantalitySunRays"
	rays.Intensity = 0.25
	rays.Spread = 0.1
	rays.Parent = Lighting
	Storage.ActiveSunRays = rays
	return rays
end

function Manager:Enable()
	CreateSky()
	CreateClouds()
	CreateSunRays()
end

function Manager:Disable()
	if Storage.ActiveSky then Storage.ActiveSky:Destroy() Storage.ActiveSky = nil end
	if Storage.ActiveClouds then Storage.ActiveClouds:Destroy() Storage.ActiveClouds = nil end
	if Storage.ActiveSunRays then Storage.ActiveSunRays:Destroy() Storage.ActiveSunRays = nil end

	if Storage.OldSky then Storage.OldSky.Parent = Lighting Storage.OldSky = nil end
	if Storage.OldClouds then Storage.OldClouds.Parent = Terrain Storage.OldClouds = nil end
	if Storage.OldSunRays then Storage.OldSunRays.Parent = Lighting Storage.OldSunRays = nil end
end

function Manager:SetSun(size, intensity, spread)
	local sky = Storage.ActiveSky or CreateSky()
	local rays = Storage.ActiveSunRays or CreateSunRays()

	if size then sky.SunAngularSize = size end
	
	if intensity or spread then
		rays.Enabled = true
		if intensity then rays.Intensity = intensity end
		if spread then rays.Spread = spread end
	end
end

function Manager:SetMoon(size)
	local sky = Storage.ActiveSky or CreateSky()
	if size then sky.MoonAngularSize = size end
end

function Manager:SetStars(count)
	local sky = Storage.ActiveSky or CreateSky()
	if count then sky.StarCount = count end
end

function Manager:SetClouds(cover, density, color)
	local clouds = Storage.ActiveClouds or CreateClouds()
	clouds.Enabled = true
	if cover then clouds.Cover = cover end
	if density then clouds.Density = density end
	if color then clouds.Color = color end
end

Manager:Enable()

Env.SkyManager = Manager
