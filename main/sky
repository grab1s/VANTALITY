local Lighting = game:GetService("Lighting")
local Terrain = workspace:WaitForChild("Terrain")
local Env = getgenv and getgenv() or _G

if Env.SkyManager then
	Env.SkyManager:Disable()
end

local Manager = {}
local Storage = {
	OldSky = nil,
	OldClouds = nil,
	OldSunRays = nil,
	ActiveSky = nil,
	ActiveClouds = nil,
	ActiveSunRays = nil,
	Settings = {
		SunSize = 11,
		SunInt = 0.25,
		SunSpread = 0.1,
		MoonSize = 11,
		Stars = 3000,
		CloudCover = 0.5,
		CloudDensity = 0.7,
		CloudColor = Color3.fromRGB(255, 255, 255)
	}
}

local function CreateSky()
	if Storage.ActiveSky then return Storage.ActiveSky end
	
	local oldSky = Lighting:FindFirstChildOfClass("Sky")
	if oldSky and oldSky.Name ~= "VantalitySky" then
		Storage.OldSky = oldSky
		oldSky.Parent = nil
	end

	local sky = Instance.new("Sky")
	sky.Name = "VantalitySky"
	sky.SkyboxBk = (oldSky and oldSky.SkyboxBk) or ""
	sky.SkyboxDn = (oldSky and oldSky.SkyboxDn) or ""
	sky.SkyboxFt = (oldSky and oldSky.SkyboxFt) or ""
	sky.SkyboxLf = (oldSky and oldSky.SkyboxLf) or ""
	sky.SkyboxRt = (oldSky and oldSky.SkyboxRt) or ""
	sky.SkyboxUp = (oldSky and oldSky.SkyboxUp) or ""
	sky.SunAngularSize = Storage.Settings.SunSize
	sky.MoonAngularSize = Storage.Settings.MoonSize
	sky.StarCount = Storage.Settings.Stars
	
	sky.Parent = Lighting
	Storage.ActiveSky = sky
	return sky
end

local function CreateClouds()
	if Storage.ActiveClouds then return Storage.ActiveClouds end

	local oldClouds = Terrain:FindFirstChildOfClass("Clouds") or Lighting:FindFirstChildOfClass("Clouds")
	if oldClouds and oldClouds.Name ~= "VantalityClouds" then
		Storage.OldClouds = oldClouds
		oldClouds.Parent = nil
	end

	local clouds = Instance.new("Clouds")
	clouds.Name = "VantalityClouds"
	clouds.Cover = Storage.Settings.CloudCover
	clouds.Density = Storage.Settings.CloudDensity
	clouds.Color = Storage.Settings.CloudColor
	clouds.Parent = Terrain
	Storage.ActiveClouds = clouds
	return clouds
end

local function CreateSunRays()
	if Storage.ActiveSunRays then return Storage.ActiveSunRays end

	local oldRays = Lighting:FindFirstChildOfClass("SunRaysEffect")
	if oldRays and oldRays.Name ~= "VantalitySunRays" then
		Storage.OldSunRays = oldRays
		oldRays.Parent = nil
	end

	local rays = Instance.new("SunRaysEffect")
	rays.Name = "VantalitySunRays"
	rays.Intensity = Storage.Settings.SunInt
	rays.Spread = Storage.Settings.SunSpread
	rays.Parent = Lighting
	Storage.ActiveSunRays = rays
	return rays
end

function Manager:Enable()
	CreateSky()
	CreateClouds()
	CreateSunRays()
end

function Manager:Disable()
	if Storage.ActiveSky then Storage.ActiveSky:Destroy() Storage.ActiveSky = nil end
	if Storage.ActiveClouds then Storage.ActiveClouds:Destroy() Storage.ActiveClouds = nil end
	if Storage.ActiveSunRays then Storage.ActiveSunRays:Destroy() Storage.ActiveSunRays = nil end

	if Storage.OldSky then Storage.OldSky.Parent = Lighting Storage.OldSky = nil end
	if Storage.OldClouds then Storage.OldClouds.Parent = Terrain Storage.OldClouds = nil end
	if Storage.OldSunRays then Storage.OldSunRays.Parent = Lighting Storage.OldSunRays = nil end
end

function Manager:SetSun(size, intensity, spread)
	if size then Storage.Settings.SunSize = size end
	if intensity then Storage.Settings.SunInt = intensity end
	if spread then Storage.Settings.SunSpread = spread end

	if Storage.ActiveSky then Storage.ActiveSky.SunAngularSize = Storage.Settings.SunSize end
	if Storage.ActiveSunRays then
		Storage.ActiveSunRays.Intensity = Storage.Settings.SunInt
		Storage.ActiveSunRays.Spread = Storage.Settings.SunSpread
	end
end

function Manager:SetMoon(size)
	if size then Storage.Settings.MoonSize = size end
	if Storage.ActiveSky then Storage.ActiveSky.MoonAngularSize = Storage.Settings.MoonSize end
end

function Manager:SetStars(count)
	if count then Storage.Settings.Stars = count end
	if Storage.ActiveSky then Storage.ActiveSky.StarCount = Storage.Settings.Stars end
end

function Manager:SetClouds(cover, density, color)
	if cover then Storage.Settings.CloudCover = cover end
	if density then Storage.Settings.CloudDensity = density end
	if color then Storage.Settings.CloudColor = color end

	if Storage.ActiveClouds then
		Storage.ActiveClouds.Cover = Storage.Settings.CloudCover
		Storage.ActiveClouds.Density = Storage.Settings.CloudDensity
		Storage.ActiveClouds.Color = Storage.Settings.CloudColor
	end
end

Env.SkyManager = Manager
