_G.SpooferSettings = {
    DisplayName = { Enabled = false, Value = "grabis", Real = "" },
    UserName    = { Enabled = false, Value = "grabis_user", Real = "" }
}

local Players = game:GetService("Players")
local CoreGui = gethui and gethui() or game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

_G.SpooferSettings.DisplayName.Real = LocalPlayer.DisplayName
_G.SpooferSettings.UserName.Real = LocalPlayer.Name

local Connections = {}

local TOKEN_USER    = "\255_USR_\255"
local TOKEN_DISPLAY = "\255_DSP_\255"

local function escape(text)
    return text:gsub("([^%w])", "%%%1")
end

local function ProcessText(text)
    local tempText = text
    local s = _G.SpooferSettings
    
    local rUser = s.UserName.Real
    local rDisp = s.DisplayName.Real
    local fUser = s.UserName.Value
    local fDisp = s.DisplayName.Value
    
    if fUser ~= "" and tempText:find(fUser, 1, true) then
        tempText = tempText:gsub(escape(fUser), escape(rUser))
    end
    if fDisp ~= "" and tempText:find(fDisp, 1, true) then
        tempText = tempText:gsub(escape(fDisp), escape(rDisp))
    end
    
    if #rUser >= #rDisp then
        tempText = tempText:gsub(escape(rUser), TOKEN_USER)
        tempText = tempText:gsub(escape(rDisp), TOKEN_DISPLAY)
    else
        tempText = tempText:gsub(escape(rDisp), TOKEN_DISPLAY)
        tempText = tempText:gsub(escape(rUser), TOKEN_USER)
    end
    
    
    local finalUser = s.UserName.Enabled and fUser or rUser
    local finalDisp = s.DisplayName.Enabled and fDisp or rDisp
    
    tempText = tempText:gsub(TOKEN_USER, function() return finalUser end)
    tempText = tempText:gsub(TOKEN_DISPLAY, function() return finalDisp end)
    
    return tempText
end

local function UpdateObject(obj)
    if not obj or not obj.Parent then return end
    
    pcall(function()
        local current = obj.Text
        if not current:find(_G.SpooferSettings.UserName.Real, 1, true) and 
           not current:find(_G.SpooferSettings.DisplayName.Real, 1, true) and
           not current:find(_G.SpooferSettings.UserName.Value, 1, true) and 
           not current:find(_G.SpooferSettings.DisplayName.Value, 1, true) then
            return
        end

        local newText = ProcessText(current)
        if current ~= newText then
            obj.Text = newText
        end
    end)
end

local function Hook(obj)
    if not obj or not obj.Parent then return end
    if Connections[obj] then return end
    
    if obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then
        Connections[obj] = true
        UpdateObject(obj)
        
        obj:GetPropertyChangedSignal("Text"):Connect(function()
            UpdateObject(obj)
        end)
        
        obj.AncestryChanged:Connect(function()
            if not obj.Parent then Connections[obj] = nil end
        end)
    end
end

local function Scan(parent)
    for _, v in pairs(parent:GetDescendants()) do
        Hook(v)
    end
    parent.DescendantAdded:Connect(function(v)
        if v:IsA("TextLabel") or v:IsA("TextButton") then
            task.wait() 
            Hook(v)
        end
    end)
end

_G.ForceUpdateNames = function()
    _G.SpooferSettings.DisplayName.Real = LocalPlayer.DisplayName
    _G.SpooferSettings.UserName.Real = LocalPlayer.Name
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local hum = LocalPlayer.Character.Humanoid
        hum.DisplayName = _G.SpooferSettings.DisplayName.Enabled and _G.SpooferSettings.DisplayName.Value or _G.SpooferSettings.DisplayName.Real
    end
    
    for obj, _ in pairs(Connections) do
        UpdateObject(obj)
    end
end

task.spawn(function()
    Scan(CoreGui)
    Scan(LocalPlayer:WaitForChild("PlayerGui"))
end)
