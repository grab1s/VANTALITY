-- // 1. ГЛОБАЛЬНЫЕ НАСТРОЙКИ //
_G.SpooferSettings = {
    DisplayName = {
        Enabled = false,
        Value = "grabis",
        Real = "Display", -- Будет авто-обновлено
    },
    UserName = {
        Enabled = false,
        Value = "grabis_user",
        Real = "User", -- Будет авто-обновлено
    }
}

local Players = game:GetService("Players")
local CoreGui = gethui and gethui() or game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

-- Авто-обновление реальных данных при запуске
_G.SpooferSettings.DisplayName.Real = LocalPlayer.DisplayName
_G.SpooferSettings.UserName.Real = LocalPlayer.Name

local Connections = {}

-- // ПОМОЩНИКИ ЭКРАНИРОВАНИЯ //

-- 1. Экранирование для ПОИСКА (Pattern)
-- Превращает "." в "%." и т.д., чтобы Lua искала именно текст, а не спецсимволы
local function escape_for_search(text)
    return text:gsub("([^%w])", "%%%1")
end

-- 2. Экранирование для ЗАМЕНЫ (Replacement)
-- В замене экранировать нужно ТОЛЬКО знак %, иначе Lua выдаст ошибку "invalid use of %"
local function escape_for_replace(text)
    return text:gsub("%%", "%%%%")
end

-- // 2. ЛОГИКА ОБРАБОТКИ //

-- Функция ОЧИСТКИ (Sanitize)
-- Возвращает текст в исходное состояние (реальные ники)
local function SanitizeText(text)
    local clean = text
    
    -- Получаем текущие настройки фейков
    local fakeDisplay = _G.SpooferSettings.DisplayName.Value
    local fakeUser = _G.SpooferSettings.UserName.Value
    
    local realDisplay = _G.SpooferSettings.DisplayName.Real
    local realUser = _G.SpooferSettings.UserName.Real

    -- 1. Если в тексте есть фейковый DisplayName -> меняем на реальный
    if fakeDisplay and fakeDisplay ~= "" and text:find(fakeDisplay, 1, true) then
        clean = clean:gsub(escape_for_search(fakeDisplay), escape_for_replace(realDisplay))
    end

    -- 2. Если в тексте есть фейковый UserName -> меняем на реальный
    if fakeUser and fakeUser ~= "" and clean:find(fakeUser, 1, true) then
        clean = clean:gsub(escape_for_search(fakeUser), escape_for_replace(realUser))
    end
    
    return clean
end

-- Функция ПРИМЕНЕНИЯ (Apply)
local function ApplySpoof(text)
    -- Шаг 1: Сначала очищаем текст от любого мусора (старых фейков)
    local newText = SanitizeText(text)
    
    local realDisplay = _G.SpooferSettings.DisplayName.Real
    local fakeDisplay = _G.SpooferSettings.DisplayName.Value
    
    local realUser = _G.SpooferSettings.UserName.Real
    local fakeUser = _G.SpooferSettings.UserName.Value

    -- Шаг 2: Замена DisplayName (Приоритет №1)
    if _G.SpooferSettings.DisplayName.Enabled then
        if newText:find(realDisplay, 1, true) then
            newText = newText:gsub(escape_for_search(realDisplay), escape_for_replace(fakeDisplay))
        end
    end

    -- Шаг 3: Замена UserName (Приоритет №2)
    if _G.SpooferSettings.UserName.Enabled then
        -- Проверяем, остался ли реальный юзернейм в тексте после замены DisplayName
        -- (Иногда DisplayName содержит UserName, и он уже заменился на шаге 2)
        if newText:find(realUser, 1, true) then
            newText = newText:gsub(escape_for_search(realUser), escape_for_replace(fakeUser))
        end
    end

    return newText
end

-- // 3. МОНИТОРИНГ ОБЪЕКТОВ //
local function MonitorObject(obj)
    if not obj or not obj.Parent then return end
    if Connections[obj] then return end -- Уже обрабатывается

    if obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then
        
        -- Попытка первичной замены
        pcall(function()
            local current = obj.Text
            local spoofed = ApplySpoof(current)
            if current ~= spoofed then
                obj.Text = spoofed
            end
        end)

        -- Подписка на изменения
        local conn = obj:GetPropertyChangedSignal("Text"):Connect(function()
            -- Чтобы избежать переполнения стека и ошибок, проверяем контент
            local current = obj.Text
            
            -- Если текст содержит РЕАЛЬНЫЕ данные (игра обновила текст)
            if current:find(_G.SpooferSettings.DisplayName.Real, 1, true) or current:find(_G.SpooferSettings.UserName.Real, 1, true) then
                local spoofed = ApplySpoof(current)
                if current ~= spoofed then
                    obj.Text = spoofed
                end
            
            -- Или если текст содержит СТАРЫЙ фейк (мы поменяли настройки, а текст старый)
            else
                local sanitized = SanitizeText(current)
                if sanitized ~= current then
                    -- Значит в тексте был фейк. Пересчитываем.
                    local newSpoof = ApplySpoof(current)
                    if current ~= newSpoof then
                        obj.Text = newSpoof
                    end
                end
            end
        end)
        
        Connections[obj] = conn
        
        -- Удаление подписки при уничтожении объекта
        obj.AncestryChanged:Connect(function()
            if not obj.Parent and Connections[obj] then
                Connections[obj]:Disconnect()
                Connections[obj] = nil
            end
        end)
    end
end

-- // 4. СКАНЕР //
local function Scan(parent)
    for _, v in pairs(parent:GetDescendants()) do
        MonitorObject(v)
    end
    parent.DescendantAdded:Connect(function(v)
        if v:IsA("TextLabel") or v:IsA("TextButton") then
            task.wait() 
            MonitorObject(v)
        end
    end)
end

-- // 5. ГЛОБАЛЬНАЯ ФУНКЦИЯ ОБНОВЛЕНИЯ //
_G.ForceUpdateNames = function()
    -- Обновляем реал имена (на случай смены команды и т.д.)
    _G.SpooferSettings.DisplayName.Real = LocalPlayer.DisplayName
    _G.SpooferSettings.UserName.Real = LocalPlayer.Name

    -- 1. Humanoid
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local hum = LocalPlayer.Character.Humanoid
        if _G.SpooferSettings.DisplayName.Enabled then
            hum.DisplayName = _G.SpooferSettings.DisplayName.Value
        else
            hum.DisplayName = _G.SpooferSettings.DisplayName.Real
        end
    end
    
    -- 2. Интерфейс
    for obj, _ in pairs(Connections) do
        if obj and obj.Parent then
            -- Просто "трогаем" текст, логика внутри .Changed сделает остальное
            -- Либо принудительно меняем:
            local current = obj.Text
            local new = ApplySpoof(current)
            if current ~= new then
                pcall(function() obj.Text = new end)
            end
        end
    end
end

-- // ЗАПУСК //
task.spawn(function()
    Scan(CoreGui)
    Scan(LocalPlayer:WaitForChild("PlayerGui"))
end)

print("V4 Spoofer Fix Loaded")
