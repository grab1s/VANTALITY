-- // НАСТРОЙКИ //
_G.SpooferSettings = {
    DisplayName = { Enabled = false, Value = "grabis", Real = "" },
    UserName    = { Enabled = false, Value = "grabis_user", Real = "" }
}

local Players = game:GetService("Players")
local CoreGui = gethui and gethui() or game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

-- Получаем реальные ники
_G.SpooferSettings.DisplayName.Real = LocalPlayer.DisplayName
_G.SpooferSettings.UserName.Real = LocalPlayer.Name

local Connections = {}

-- Обязательная функция для Lua (чтобы точки и скобки в никах не ломали поиск)
local function escape(text)
    return text:gsub("([^%w])", "%%%1")
end

-- // ПРОСТАЯ ЗАМЕНА //
local function ProcessText(text)
    local newText = text
    local s = _G.SpooferSettings
    
    -- Просто заменяем Display Name
    if s.DisplayName.Enabled then
        newText = newText:gsub(escape(s.DisplayName.Real), s.DisplayName.Value)
    end
    
    -- Просто заменяем User Name
    if s.UserName.Enabled then
        newText = newText:gsub(escape(s.UserName.Real), s.UserName.Value)
    end
    
    return newText
end

-- // ОБНОВЛЕНИЕ ОБЪЕКТА //
local function UpdateObject(obj)
    -- Защита от удаления
    if not obj or not obj.Parent then return end
    
    pcall(function()
        -- 1. Берем текущий текст
        local current = obj.Text
        
        -- 2. Если в тексте есть наши реальные имена - меняем
        -- (Проверка find ускоряет работу, чтобы не делать gsub там где не надо)
        if current:find(_G.SpooferSettings.DisplayName.Real, 1, true) or 
           current:find(_G.SpooferSettings.UserName.Real, 1, true) then
            
            local changed = ProcessText(current)
            
            -- Если текст изменился - применяем
            if current ~= changed then
                obj.Text = changed
            end
        end
    end)
end

-- // ПОДКЛЮЧЕНИЕ //
local function Hook(obj)
    if not obj or not obj.Parent then return end
    if Connections[obj] then return end
    
    if obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then
        Connections[obj] = true
        
        -- Применяем сразу
        UpdateObject(obj)
        
        -- Слушаем изменения (чтобы таб/чат не возвращали старый ник)
        obj:GetPropertyChangedSignal("Text"):Connect(function()
            UpdateObject(obj)
        end)
        
        obj.AncestryChanged:Connect(function()
            if not obj.Parent then Connections[obj] = nil end
        end)
    end
end

-- // СКАНЕР //
local function Scan(parent)
    for _, v in pairs(parent:GetDescendants()) do
        Hook(v)
    end
    parent.DescendantAdded:Connect(function(v)
        if v:IsA("TextLabel") or v:IsA("TextButton") then
            task.wait()
            Hook(v)
        end
    end)
end

-- // ТРИГГЕР ИЗ ТВОЕГО GUI //
_G.ForceUpdateNames = function()
    -- Обновляем настройки
    _G.SpooferSettings.DisplayName.Real = LocalPlayer.DisplayName
    _G.SpooferSettings.UserName.Real = LocalPlayer.Name
    
    -- Обновляем имя над персонажем
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local hum = LocalPlayer.Character.Humanoid
        if _G.SpooferSettings.DisplayName.Enabled then
            hum.DisplayName = _G.SpooferSettings.DisplayName.Value
        else
            hum.DisplayName = _G.SpooferSettings.DisplayName.Real
        end
    end
    
    -- Обновляем интерфейс
    for obj, _ in pairs(Connections) do
        UpdateObject(obj)
    end
end

-- // ЗАПУСК //
task.spawn(function()
    Scan(CoreGui)
    Scan(LocalPlayer:WaitForChild("PlayerGui"))
end)

print("Simple Direct Spoofer Loaded")
