local Env = getgenv and getgenv() or _G

-- >> Очистка старой версии перед запуском новой
if Env.SL_SCRIPT_INSTANCE and typeof(Env.SL_SCRIPT_INSTANCE.Cleanup) == "function" then
    Env.SL_SCRIPT_INSTANCE:Cleanup()
end

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- >> Настройки и Состояние
local State = {
    isScriptEnabled = false, -- Главный рубильник (через GUI)
    isLocked = false,        -- Текущее состояние шифт-лока (по кнопке)
    connections = {},
    defaultGuiCache = {},    -- Сюда сохраняем стандартные GUI, чтобы восстановить их
    bindKey = Enum.KeyCode.RightShift, -- Клавиша по умолчанию
}

local Settings = {
    OffsetX = 2.5,
    OffsetY = 0.5,
    Smoothness = 0.2,
    CursorId = "rbxassetid://2452296680",
    UseCustomCursor = true
}

-- >> Вспомогательные функции
local function getDefaultGuiObjects()
    -- Список путей к стандартному шифт-локу
    local targets = {}
    
    -- 1. PlayerGui
    local pg = LocalPlayer:FindFirstChild("PlayerGui")
    if pg then 
        local sl = pg:FindFirstChild("ScreenGui") or pg:FindFirstChild("ShiftLock") -- Иногда называется по-разному
        if sl and sl:IsA("ScreenGui") and sl:FindFirstChild("ImageLabel") then table.insert(targets, sl) end
    end

    -- 2. StarterGui (на всякий случай)
    local sg = game:GetService("StarterGui")
    if sg then
        local sl = sg:FindFirstChild("ShiftLock")
        if sl then table.insert(targets, sl) end
    end
    
    return targets
end

local function toggleDefaultShiftLock(enable)
    -- Если enable = true, мы ВОССТАНАВЛИВАЕМ дефолт. Если false - СКРЫВАЕМ.
    
    -- Обработка GUI
    if not enable then
        -- Скрываем и запоминаем
        State.defaultGuiCache = getDefaultGuiObjects()
        for _, gui in pairs(State.defaultGuiCache) do
            if gui and gui.Parent then
                gui.Enabled = false
            end
        end
    else
        -- Восстанавливаем
        for _, gui in pairs(State.defaultGuiCache) do
            if gui and gui.Parent then
                gui.Enabled = true
            end
        end
        State.defaultGuiCache = {}
    end
    
    -- Обработка настройки игрока
    pcall(function()
        LocalPlayer.DevEnableMouseLock = enable -- Вкл/Выкл стандартную возможность
    end)
end

-- >> Основная логика обновления (RenderStepped)
local currentOffset = Vector3.new(0,0,0)

local function onRenderStep(deltaTime)
    if not State.isScriptEnabled then return end
    
    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local humanoid = char and char:FindFirstChild("Humanoid")
    
    if not hrp or not humanoid then return end

    -- Если режим активирован кнопкой
    if State.isLocked then
        -- 1. Лок мыши
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
        
        -- 2. Кастомный курсор
        if Settings.UseCustomCursor then
            Mouse.Icon = Settings.CursorId
        end

        -- 3. Плавный оффсет камеры
        local targetVec = Vector3.new(Settings.OffsetX, Settings.OffsetY, 0)
        currentOffset = currentOffset:Lerp(targetVec, math.clamp(Settings.Smoothness * 60 * deltaTime, 0, 1))
        humanoid.CameraOffset = currentOffset

        -- 4. Вращение персонажа (Исправленное, без дерганья)
        -- Отключаем авто-поворот, чтобы скрипт сам управлял
        humanoid.AutoRotate = false 
        
        local camCFrame = Camera.CFrame
        local x, y, z = camCFrame:ToOrientation()
        
        -- Создаем новый CFrame: позиция персонажа + угол поворота камеры по Y
        -- Используем Lerp для мягкости, но достаточно быстрый (0.5), чтобы не было "желейности" при стрельбе
        local newCFrame = CFrame.new(hrp.Position) * CFrame.Angles(0, y, 0)
        hrp.CFrame = hrp.CFrame:Lerp(newCFrame, 0.6) 
        
    else
        -- Если режим выключен (но скрипт активен), плавно возвращаем камеру в 0
        if currentOffset.Magnitude > 0.01 then
            currentOffset = currentOffset:Lerp(Vector3.new(0,0,0), math.clamp(Settings.Smoothness * 60 * deltaTime, 0, 1))
            humanoid.CameraOffset = currentOffset
        else
            humanoid.CameraOffset = Vector3.new(0,0,0)
        end
        
        -- Возвращаем дефолтные настройки персонажа
        humanoid.AutoRotate = true
        Mouse.Icon = ""
        -- MouseBehavior сбрасывать не обязательно каждый кадр, но можно для надежности,
        -- если мышь не зажата (ПКМ).
    end
end

-- >> Обработка ввода (Клавиша)
local function onInput(input, gameProcessed)
    if not State.isScriptEnabled then return end
    if gameProcessed then return end
    
    if input.KeyCode == State.bindKey then
        State.isLocked = not State.isLocked
        
        -- При выключении сразу сбрасываем курсор
        if not State.isLocked then
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        end
    end
end

-- >> Контроллер (Интерфейс для GUI)
local ShiftLockController = {}

function ShiftLockController:EnableSystem()
    if State.isScriptEnabled then return end
    State.isScriptEnabled = true
    
    -- Скрываем дефолтный
    toggleDefaultShiftLock(false)
    
    -- Подключаем события
    -- Используем BindToRenderStep с высоким приоритетом для плавности камеры
    RunService:BindToRenderStep("CustomShiftLock_Update", Enum.RenderPriority.Character.Value + 1, onRenderStep)
    
    local inputConn = UserInputService.InputBegan:Connect(onInput)
    table.insert(State.connections, inputConn)
end

function ShiftLockController:DisableSystem()
    if not State.isScriptEnabled then return end
    State.isScriptEnabled = false
    State.isLocked = false -- Сбрасываем лок
    
    -- Очищаем события
    RunService:UnbindFromRenderStep("CustomShiftLock_Update")
    for _, conn in pairs(State.connections) do conn:Disconnect() end
    State.connections = {}
    
    -- Восстанавливаем персонажа
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.CameraOffset = Vector3.new(0,0,0)
        LocalPlayer.Character.Humanoid.AutoRotate = true
    end
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    Mouse.Icon = ""
    
    -- Восстанавливаем дефолтный шифт-лок игры
    toggleDefaultShiftLock(true)
end

function ShiftLockController:SetOffset(axis, val)
    if axis == "X" then Settings.OffsetX = tonumber(val) or Settings.OffsetX end
    if axis == "Y" then Settings.OffsetY = tonumber(val) or Settings.OffsetY end
end

function ShiftLockController:SetKeybind(key)
    if typeof(key) == "EnumItem" then
        State.bindKey = key
    end
end

function ShiftLockController:SetSmoothness(val)
    local n = tonumber(val)
    if n then Settings.Smoothness = n / 20 end
end

function ShiftLockController:SetCursor(id)
    if not id then return end
    if not tostring(id):find("rbxassetid") and tonumber(id) then
        Settings.CursorId = "rbxassetid://"..id
    else
        Settings.CursorId = id
    end
end

-- >> Cleanup / Export
local function cleanup()
    ShiftLockController:DisableSystem()
    Env.ShiftLock = nil
    Env.SL_SCRIPT_INSTANCE = nil
end

Env.ShiftLock = ShiftLockController
Env.SL_SCRIPT_INSTANCE = { Cleanup = cleanup }
