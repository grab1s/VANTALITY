local Env = getgenv and getgenv() or _G

if Env.SHIFTLOCK_SCRIPT_INSTANCE and typeof(Env.SHIFTLOCK_SCRIPT_INSTANCE.Cleanup) == "function" then
    Env.SHIFTLOCK_SCRIPT_INSTANCE:Cleanup()
    task.wait(0.1)
end

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Пытаемся безопасно получить контроллер
local PlayerScripts = LocalPlayer:WaitForChild("PlayerScripts")
local PlayerModule = require(PlayerScripts:WaitForChild("PlayerModule"))
local CameraModule = PlayerModule:GetCameras()
local MouseLockController = CameraModule.activeMouseLockController

-- Если контроллер еще не создан (игрок не нажал шифт), ждем или ищем его в метатаблице
if not MouseLockController then
    -- Иногда он инициализируется лениво, попробуем форсировать получение через API камеры, если есть
    if CameraModule.activeMouseLockController then
        MouseLockController = CameraModule.activeMouseLockController
    end
end

local isEnabled = false
local updateConnection = nil

local settings = {
    Smoothness = 0.15,
    OffsetX = 1.75,
    OffsetY = 0.5,
    CustomCursorId = "",
    IsCustomCursorEnabled = false
}

local currentOffset = Vector3.new(0, 0, 0)
local originalGetCameraOffset = nil
local currentCursorImage = nil

local ShiftLockController = {}

-- Безопасная замена функции (вместо hookfunction, который крашит)
local function replaceInternalFunction()
    if not MouseLockController then 
        MouseLockController = CameraModule.activeMouseLockController
    end
    
    if not MouseLockController then return end

    -- Снимаем защиту с таблицы, если она есть
    if setreadonly then setreadonly(MouseLockController, false) end

    -- Сохраняем оригинал
    if not originalGetCameraOffset then
        originalGetCameraOffset = MouseLockController.GetCameraOffset
    end

    -- Просто перезаписываем функцию в таблице. Это безопаснее, чем hookfunction для этого модуля.
    MouseLockController.GetCameraOffset = function(self)
        return Vector3.new(0, 0, 0) -- Отключаем нативный рывок
    end
end

local function restoreInternalFunction()
    if MouseLockController and originalGetCameraOffset then
        if setreadonly then setreadonly(MouseLockController, false) end
        MouseLockController.GetCameraOffset = originalGetCameraOffset
        originalGetCameraOffset = nil
    end
end

-- Поиск и обновление курсора
local function updateCursorTexture()
    if not settings.IsCustomCursorEnabled then
        if currentCursorImage then currentCursorImage.Image = "rbxasset://textures/MouseLockedCursor.png" end
        return 
    end
    
    if settings.CustomCursorId == "" or settings.CustomCursorId == " " then return end

    local targetImage = settings.CustomCursorId
    
    -- Обработка путей
    if not targetImage:find("rbxasset") and not targetImage:find("http") then
        if isfile and isfile(targetImage) and getcustomasset then
            targetImage = getcustomasset(targetImage)
        elseif tonumber(targetImage) then
            targetImage = "rbxassetid://" .. targetImage
        end
    end

    local pGui = LocalPlayer:WaitForChild("PlayerGui")
    -- Ищем GUI шифтлока
    for _, gui in pairs(pGui:GetChildren()) do
        if (gui.Name == "ScreenGui" or gui.Name == "ShiftLock") and gui:IsA("ScreenGui") then
            local imageLabel = gui:FindFirstChild("MouseLockLabel", true)
            if imageLabel and imageLabel:IsA("ImageLabel") then
                currentCursorImage = imageLabel
                currentCursorImage.Image = targetImage
                break
            end
        end
    end
end

local function onRenderStepped(deltaTime)
    if not LocalPlayer.Character then return end
    local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end

    -- Если контроллер потерялся (например, ресет), ищем снова
    if not MouseLockController then
        MouseLockController = CameraModule.activeMouseLockController
        if isEnabled and MouseLockController then replaceInternalFunction() end
        return
    end

    local isLocked = MouseLockController:GetIsMouseLocked()
    local targetVector = Vector3.new(0, 0, 0)

    if isLocked and isEnabled then
        targetVector = Vector3.new(settings.OffsetX, settings.OffsetY, 0)
        
        if settings.IsCustomCursorEnabled then
             if not currentCursorImage or not currentCursorImage.Parent or currentCursorImage.Image ~= settings.CustomCursorId then
                 updateCursorTexture() 
             end
        end
    end

    -- Логика плавности
    local lerpFactor = math.clamp(deltaTime * (60 * settings.Smoothness), 0, 1)
    currentOffset = currentOffset:Lerp(targetVector, settings.Smoothness)
    humanoid.CameraOffset = currentOffset
end

function ShiftLockController:enable()
    if isEnabled then return end
    isEnabled = true
    replaceInternalFunction()
    if not updateConnection then 
        updateConnection = RunService.RenderStepped:Connect(onRenderStepped) 
    end
end

function ShiftLockController:disable()
    if not isEnabled then return end
    isEnabled = false
    restoreInternalFunction()
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.CameraOffset = Vector3.new(0,0,0)
    end
    currentOffset = Vector3.new(0,0,0)
    
    if updateConnection then 
        updateConnection:Disconnect()
        updateConnection = nil
    end
end

function ShiftLockController:updateSetting(settingName, value)
    if settings[settingName] == nil then return end
    
    if settingName == "Smoothness" then
        local num = tonumber(value)
        if num then settings.Smoothness = num / 100 end 
    elseif settingName == "CustomCursorId" then
        settings.CustomCursorId = tostring(value)
        updateCursorTexture() 
    else
        settings[settingName] = value
    end
end

local cleanupFunction = function()
    isEnabled = false
    restoreInternalFunction()
    if updateConnection then updateConnection:Disconnect() end
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.CameraOffset = Vector3.new(0,0,0)
    end
    Env.SHIFTLOCK = nil
    Env.SHIFTLOCK_SCRIPT_INSTANCE = nil
end

Env.SHIFTLOCK = ShiftLockController
Env.SHIFTLOCK_SCRIPT_INSTANCE = { Cleanup = cleanupFunction }
