local Env = getgenv and getgenv() or _G

-- >> Очистка
if Env.SL_SCRIPT_INSTANCE and typeof(Env.SL_SCRIPT_INSTANCE.Cleanup) == "function" then
    Env.SL_SCRIPT_INSTANCE:Cleanup()
end

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- >> Состояние
local State = {
    isSystemEnabled = false,
    isActive = false,
    bindKey = Enum.KeyCode.RightShift,
    inputConn = nil
}

local Settings = {
    OffsetX = 2.5,
    OffsetY = 0.5,
    Smoothness = 0.2, -- Это только для камеры (Offset), поворот персонажа будет моментальным
    CursorId = "rbxassetid://2452296680",
}

-- >> Утилита для скрытия/показа дефолтного шифтлока
local function toggleDefaultShiftLock(enable)
    pcall(function() LocalPlayer.DevEnableMouseLock = enable end)
    
    local paths = {
        LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ScreenGui") and LocalPlayer.PlayerGui.ScreenGui:FindFirstChild("ShiftLock"),
        LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ShiftLock"),
        game:GetService("StarterGui"):FindFirstChild("ShiftLock")
    }

    for _, gui in pairs(paths) do
        if gui then
            pcall(function()
                if gui:IsA("ScreenGui") or gui:IsA("LayerCollector") then gui.Enabled = enable
                elseif gui:IsA("GuiObject") then gui.Visible = enable end
            end)
        end
    end
end

-- >> Основной цикл
local currentCamOffset = Vector3.new(0,0,0)

local function onRenderStep(deltaTime)
    if not State.isSystemEnabled then return end

    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChild("Humanoid")

    if not hrp or not hum then return end

    if State.isActive then
        -- 1. Лок курсора и иконка
        if UserInputService.MouseBehavior ~= Enum.MouseBehavior.LockCenter then
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
        end
        if Mouse.Icon ~= Settings.CursorId then
            Mouse.Icon = Settings.CursorId
        end

        -- 2. Смещение камеры (Offset) - оставляем плавным для красоты
        local targetOff = Vector3.new(Settings.OffsetX, Settings.OffsetY, 0)
        currentCamOffset = currentCamOffset:Lerp(targetOff, math.clamp(Settings.Smoothness * 60 * deltaTime, 0, 1))
        hum.CameraOffset = currentCamOffset

        -- 3. Вращение персонажа (ЖЕСТКОЕ и МОМЕНТАЛЬНОЕ)
        hum.AutoRotate = false -- Принудительно отключаем каждый кадр (если полет включил обратно)
        
        -- Вычисляем угол поворота камеры ТОЛЬКО по горизонту (Y)
        local lookVec = Camera.CFrame.LookVector
        -- Используем atan2 для получения чистого угла поворота из вектора взгляда
        local targetAngle = math.atan2(-lookVec.X, -lookVec.Z) 
        
        -- Создаем новый CFrame:
        -- Берем ТЕКУЩУЮ позицию персонажа (hrp.Position) - это важно для совместимости с полетом/ходьбой
        -- И применяем ТОЛЬКО вращение.
        hrp.CFrame = CFrame.new(hrp.Position) * CFrame.Angles(0, targetAngle, 0)
        
    else
        -- Возвращение в норму
        if currentCamOffset.Magnitude > 0.05 then
             currentCamOffset = currentCamOffset:Lerp(Vector3.new(0,0,0), math.clamp(Settings.Smoothness * 60 * deltaTime, 0, 1))
             hum.CameraOffset = currentCamOffset
        else
             hum.CameraOffset = Vector3.new(0,0,0)
        end
        
        -- Возвращаем управление игрой, только если мы полностью отключили режим
        if not State.isActive then
            hum.AutoRotate = true
            Mouse.Icon = ""
            -- MouseBehavior сбрасываем в DisableSystem или Input, здесь не трогаем чтобы не мигало
        end
    end
end

-- >> Input
local function onInput(input, gameProcessed)
    if not State.isSystemEnabled then return end
    if gameProcessed then return end
    
    if input.KeyCode == State.bindKey then
        State.isActive = not State.isActive
        if not State.isActive then
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        end
    end
end

-- >> Controller
local Controller = {}

function Controller:EnableSystem()
    if State.isSystemEnabled then return end
    State.isSystemEnabled = true
    
    toggleDefaultShiftLock(false)
    
    -- Приоритет Camera.Value + 1 гарантирует, что камера уже обновилась, 
    -- и мы поворачиваем персонажа ровно туда, куда она смотрит.
    RunService:BindToRenderStep("SL_Hard_Lock", Enum.RenderPriority.Camera.Value + 1, onRenderStep)
    
    State.inputConn = UserInputService.InputBegan:Connect(onInput)
end

function Controller:DisableSystem()
    if not State.isSystemEnabled then return end
    State.isSystemEnabled = false
    State.isActive = false
    
    pcall(function() RunService:UnbindFromRenderStep("SL_Hard_Lock") end)
    if State.inputConn then State.inputConn:Disconnect() end
    
    toggleDefaultShiftLock(true)
    
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    Mouse.Icon = ""
    
    if LocalPlayer.Character then
        local hum = LocalPlayer.Character:FindFirstChild("Humanoid")
        if hum then 
            hum.CameraOffset = Vector3.new(0,0,0)
            hum.AutoRotate = true 
        end
    end
end

function Controller:SetKeybind(val)
    if typeof(val) == "EnumItem" then State.bindKey = val
    elseif typeof(val) == "string" then
        local keyName = val:match("Enum%.KeyCode%.(.+)") or val
        if Enum.KeyCode[keyName] then State.bindKey = Enum.KeyCode[keyName] end
    end
end

function Controller:SetOffset(axis, val)
    local n = tonumber(val)
    if n then
        if axis == "X" then Settings.OffsetX = n end
        if axis == "Y" then Settings.OffsetY = n end
    end
end

function Controller:SetSmoothness(val)
    local n = tonumber(val)
    if n then Settings.Smoothness = n / 20 end
end

function Controller:SetCursor(val)
    if not val then return end
    if tonumber(val) then Settings.CursorId = "rbxassetid://"..val else Settings.CursorId = val end
end

-- >> Cleanup
local function cleanup()
    Controller:DisableSystem()
    Env.ShiftLock = nil
    Env.SL_SCRIPT_INSTANCE = nil
end

Env.ShiftLock = Controller
Env.SL_SCRIPT_INSTANCE = { Cleanup = cleanup }
