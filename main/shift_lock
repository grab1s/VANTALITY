local Env = getgenv and getgenv() or _G

-- >> Cleanup
if Env.SL_SCRIPT_INSTANCE and typeof(Env.SL_SCRIPT_INSTANCE.Cleanup) == "function" then
    Env.SL_SCRIPT_INSTANCE:Cleanup()
end

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- >> Состояние
local State = {
    isSystemEnabled = false, -- Включена ли сама система (через GUI)
    isActive = false,        -- Активен ли ShiftLock (нажата клавиша)
    bindKey = Enum.KeyCode.RightShift,
    gyro = nil,              -- Ссылка на наш BodyGyro
    defaultCache = {}        -- Для восстановления
}

local Settings = {
    OffsetX = 2.5,
    OffsetY = 0.5,
    Smoothness = 0.2, 
    CursorId = "rbxassetid://2452296680",
}

-- >> Утилиты
local function getGyro(rootPart)
    if not rootPart then return nil end
    local gyro = rootPart:FindFirstChild("ShiftLockGyro_Vantality")
    if not gyro then
        gyro = Instance.new("BodyGyro")
        gyro.Name = "ShiftLockGyro_Vantality"
        gyro.P = 30000 -- Сила поворота (чем больше, тем резче)
        gyro.D = 500   -- Гашение колебаний (чтобы не трясло)
        -- Блокируем ТОЛЬКО ось Y (вращение влево-вправо). 
        -- X и Z ставим в 0, чтобы другие скрипты (полет) могли наклонять перса.
        gyro.MaxTorque = Vector3.new(0, 400000, 0) 
        gyro.Parent = rootPart
    end
    return gyro
end

local function toggleDefaultShiftLock(visible)
    -- Прячем/Показываем стандартную иконку и отключаем встроенный лок
    local guiPaths = {
        LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ScreenGui") and LocalPlayer.PlayerGui.ScreenGui:FindFirstChild("ShiftLock"), -- Стандартный путь
        LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ShiftLock"), -- Альтернативный
    }

    if not visible then
        pcall(function() LocalPlayer.DevEnableMouseLock = false end)
        for _, gui in pairs(guiPaths) do
            if gui then gui.Visible = false end
        end
    else
        pcall(function() LocalPlayer.DevEnableMouseLock = true end)
        for _, gui in pairs(guiPaths) do
            if gui then gui.Visible = true end
        end
    end
end

-- >> Основной цикл (RenderStepped)
local currentCamOffset = Vector3.new(0,0,0)

local function onRenderStep(deltaTime)
    if not State.isSystemEnabled then return end

    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChild("Humanoid")

    if not hrp or not hum then return end

    if State.isActive then
        -- 1. Лок мыши и курсор
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
        Mouse.Icon = Settings.CursorId

        -- 2. Плавный оффсет камеры
        local targetOff = Vector3.new(Settings.OffsetX, Settings.OffsetY, 0)
        currentCamOffset = currentCamOffset:Lerp(targetOff, math.clamp(Settings.Smoothness * 60 * deltaTime, 0, 1))
        hum.CameraOffset = currentCamOffset

        -- 3. Вращение персонажа (Через BodyGyro - FIX ТРЯСКИ и ПОЛЕТА)
        hum.AutoRotate = false -- Отключаем нативное вращение
        
        local gyro = getGyro(hrp)
        if gyro then
            gyro.MaxTorque = Vector3.new(0, 400000, 0) -- Включаем силу
            -- Поворачиваем Gyro туда, куда смотрит камера (только Y)
            local _, camY, _ = Camera.CFrame:ToOrientation()
            gyro.CFrame = CFrame.new(hrp.Position) * CFrame.Angles(0, camY, 0)
        end

    else
        -- Если выключено (возврат в норму)
        if currentCamOffset.Magnitude > 0.05 then
             currentCamOffset = currentCamOffset:Lerp(Vector3.new(0,0,0), math.clamp(Settings.Smoothness * 60 * deltaTime, 0, 1))
             hum.CameraOffset = currentCamOffset
        else
             hum.CameraOffset = Vector3.new(0,0,0)
        end
        
        hum.AutoRotate = true
        Mouse.Icon = ""
        
        -- Отключаем Gyro
        local gyro = hrp:FindFirstChild("ShiftLockGyro_Vantality")
        if gyro then gyro.MaxTorque = Vector3.new(0, 0, 0) end
    end
end

-- >> Обработка ввода
local function onInput(input, gameProcessed)
    if not State.isSystemEnabled then return end
    if gameProcessed then return end
    
    -- Проверка клавиши (учитываем разные типы ввода)
    if input.KeyCode == State.bindKey then
        State.isActive = not State.isActive
        
        if not State.isActive then
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        end
    end
end

-- >> API Контроллер
local Controller = {}

function Controller:EnableSystem()
    if State.isSystemEnabled then return end
    State.isSystemEnabled = true
    toggleDefaultShiftLock(false) -- Скрываем дефолт
    
    RunService:BindToRenderStep("SL_Render", Enum.RenderPriority.Camera.Value + 1, onRenderStep)
    State.inputConn = UserInputService.InputBegan:Connect(onInput)
end

function Controller:DisableSystem()
    if not State.isSystemEnabled then return end
    State.isSystemEnabled = false
    State.isActive = false
    
    RunService:UnbindFromRenderStep("SL_Render")
    if State.inputConn then State.inputConn:Disconnect() end
    
    toggleDefaultShiftLock(true) -- Восстанавливаем дефолт
    
    -- Чистка
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    Mouse.Icon = ""
    if LocalPlayer.Character then
        local hum = LocalPlayer.Character:FindFirstChild("Humanoid")
        local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if hum then 
            hum.CameraOffset = Vector3.new(0,0,0) 
            hum.AutoRotate = true
        end
        if hrp then
            local g = hrp:FindFirstChild("ShiftLockGyro_Vantality")
            if g then g:Destroy() end
        end
    end
end

function Controller:SetKeybind(val)
    -- Универсальная обработка бинда
    if typeof(val) == "EnumItem" then
        State.bindKey = val
    elseif typeof(val) == "string" then
        -- Если библиотека вернула "Enum.KeyCode.LeftAlt" или просто "LeftAlt"
        local keyName = val:match("Enum%.KeyCode%.(.+)") or val
        if Enum.KeyCode[keyName] then
            State.bindKey = Enum.KeyCode[keyName]
        end
    elseif typeof(val) == "table" and val.Name then
         -- Некоторые либы (Solaris) возвращают таблицу
         State.bindKey = val
    end
end

function Controller:SetOffset(axis, val)
    if axis == "X" then Settings.OffsetX = tonumber(val) end
    if axis == "Y" then Settings.OffsetY = tonumber(val) end
end

function Controller:SetCursor(val)
    if not val then return end
    if tonumber(val) then Settings.CursorId = "rbxassetid://"..val else Settings.CursorId = val end
end

-- >> Экспорт
local function cleanup()
    Controller:DisableSystem()
    Env.ShiftLock = nil
    Env.SL_SCRIPT_INSTANCE = nil
end

Env.ShiftLock = Controller
Env.SL_SCRIPT_INSTANCE = { Cleanup = cleanup }
