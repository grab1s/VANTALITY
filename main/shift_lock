local Env = getgenv and getgenv() or _G

-- >> Cleanup22222
if Env.SL_SCRIPT_INSTANCE and typeof(Env.SL_SCRIPT_INSTANCE.Cleanup) == "function" then
    Env.SL_SCRIPT_INSTANCE:Cleanup()
end

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- >> Состояние
local State = {
    isSystemEnabled = false,
    isActive = false,
    bindKey = Enum.KeyCode.RightShift,
    inputConn = nil,
    defaultCache = {} 
}

local Settings = {
    OffsetX = 2.5,
    OffsetY = 0.5,
    Smoothness = 0.2, 
    CursorId = "rbxassetid://2452296680",
}

-- >> Утилиты
local function getGyro(rootPart)
    if not rootPart then return nil end
    local gyro = rootPart:FindFirstChild("ShiftLockGyro_Vantality")
    if not gyro then
        gyro = Instance.new("BodyGyro")
        gyro.Name = "ShiftLockGyro_Vantality"
        gyro.P = 30000 
        gyro.D = 500   
        gyro.MaxTorque = Vector3.new(0, 400000, 0) 
        gyro.Parent = rootPart
    end
    return gyro
end

local function toggleDefaultShiftLock(enable)
    -- enable = true -> Показать дефолт
    -- enable = false -> Скрыть дефолт
    
    local guiPaths = {
        LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ScreenGui") and LocalPlayer.PlayerGui.ScreenGui:FindFirstChild("ShiftLock"),
        LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ShiftLock"), -- Часто здесь
        game:GetService("StarterGui"):FindFirstChild("ShiftLock")
    }

    -- Обработка настройки движка
    pcall(function() LocalPlayer.DevEnableMouseLock = enable end)

    -- Обработка GUI (FIX ОШИБКИ Visible)
    for _, gui in pairs(guiPaths) do
        if gui then
            pcall(function()
                if gui:IsA("ScreenGui") or gui:IsA("LayerCollector") then
                    gui.Enabled = enable
                elseif gui:IsA("GuiObject") then -- Frame, ImageLabel, etc.
                    gui.Visible = enable
                end
            end)
        end
    end
end

-- >> Render Loop
local currentCamOffset = Vector3.new(0,0,0)

local function onRenderStep(deltaTime)
    if not State.isSystemEnabled then return end

    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChild("Humanoid")

    if not hrp or not hum then return end

    if State.isActive then
        -- Лок и Курсор
        if UserInputService.MouseBehavior ~= Enum.MouseBehavior.LockCenter then
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
        end
        
        if Mouse.Icon ~= Settings.CursorId then
            Mouse.Icon = Settings.CursorId
        end

        -- Камера
        local targetOff = Vector3.new(Settings.OffsetX, Settings.OffsetY, 0)
        currentCamOffset = currentCamOffset:Lerp(targetOff, math.clamp(Settings.Smoothness * 60 * deltaTime, 0, 1))
        hum.CameraOffset = currentCamOffset

        -- Вращение (FIX ТРЯСКИ)
        hum.AutoRotate = false
        local gyro = getGyro(hrp)
        if gyro then
            gyro.MaxTorque = Vector3.new(0, 400000, 0)
            local _, camY, _ = Camera.CFrame:ToOrientation()
            gyro.CFrame = CFrame.new(hrp.Position) * CFrame.Angles(0, camY, 0)
        end
    else
        -- Возврат
        if currentCamOffset.Magnitude > 0.05 then
             currentCamOffset = currentCamOffset:Lerp(Vector3.new(0,0,0), math.clamp(Settings.Smoothness * 60 * deltaTime, 0, 1))
             hum.CameraOffset = currentCamOffset
        else
             hum.CameraOffset = Vector3.new(0,0,0)
        end
        
        hum.AutoRotate = true
        Mouse.Icon = ""
        local gyro = hrp:FindFirstChild("ShiftLockGyro_Vantality")
        if gyro then gyro.MaxTorque = Vector3.new(0, 0, 0) end
    end
end

-- >> Input
local function onInput(input, gameProcessed)
    if not State.isSystemEnabled then return end
    if gameProcessed then return end
    
    if input.KeyCode == State.bindKey then
        State.isActive = not State.isActive
        if not State.isActive then
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        end
    end
end

-- >> Controller
local Controller = {}

function Controller:EnableSystem()
    if State.isSystemEnabled then return end
    State.isSystemEnabled = true
    
    toggleDefaultShiftLock(false)
    RunService:BindToRenderStep("SL_Render_Vantality", Enum.RenderPriority.Camera.Value + 1, onRenderStep)
    State.inputConn = UserInputService.InputBegan:Connect(onInput)
end

function Controller:DisableSystem()
    if not State.isSystemEnabled then return end
    State.isSystemEnabled = false
    State.isActive = false
    
    pcall(function() RunService:UnbindFromRenderStep("SL_Render_Vantality") end)
    if State.inputConn then State.inputConn:Disconnect() end
    
    toggleDefaultShiftLock(true)
    
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    Mouse.Icon = ""
    
    if LocalPlayer.Character then
        local hum = LocalPlayer.Character:FindFirstChild("Humanoid")
        local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if hum then hum.CameraOffset = Vector3.new(0,0,0); hum.AutoRotate = true end
        if hrp and hrp:FindFirstChild("ShiftLockGyro_Vantality") then
            hrp.ShiftLockGyro_Vantality:Destroy()
        end
    end
end

function Controller:SetKeybind(val)
    if typeof(val) == "EnumItem" then State.bindKey = val
    elseif typeof(val) == "string" then
        local keyName = val:match("Enum%.KeyCode%.(.+)") or val
        if Enum.KeyCode[keyName] then State.bindKey = Enum.KeyCode[keyName] end
    end
end

function Controller:SetOffset(axis, val)
    local n = tonumber(val)
    if n then
        if axis == "X" then Settings.OffsetX = n end
        if axis == "Y" then Settings.OffsetY = n end
    end
end

-- FIX ОШИБКИ: Добавлена функция SetSmoothness
function Controller:SetSmoothness(val)
    local n = tonumber(val)
    if n then Settings.Smoothness = n / 20 end
end

function Controller:SetCursor(val)
    if not val then return end
    if tonumber(val) then Settings.CursorId = "rbxassetid://"..val else Settings.CursorId = val end
end

-- >> Export
local function cleanup()
    Controller:DisableSystem()
    Env.ShiftLock = nil
    Env.SL_SCRIPT_INSTANCE = nil
end

Env.ShiftLock = Controller
Env.SL_SCRIPT_INSTANCE = { Cleanup = cleanup }
