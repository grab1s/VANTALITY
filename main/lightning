local Lighting = game:GetService("Lighting")
local ControllerKey = "LightingController"

if _G[ControllerKey] then
	_G[ControllerKey]:Destroy()
end

local Defaults = {
	Ambient = Lighting.Ambient,
	OutdoorAmbient = Lighting.OutdoorAmbient,
	ColorShift_Top = Lighting.ColorShift_Top,
	ColorShift_Bottom = Lighting.ColorShift_Bottom,
	GlobalShadows = Lighting.GlobalShadows
}

local Bloom = Instance.new("BloomEffect")
Bloom.Name = "ManagedBloom"

local Controller = {}
Controller.Enabled = false
Controller.Settings = {
	Bloom = {
		Intensity = 1,
		Size = 24,
		Threshold = 2
	},
	Lighting = {
		ShadowColor = Color3.fromRGB(0, 0, 0),
		EnvironmentColor = Color3.fromRGB(100, 100, 100),
		GlobalShadows = true
	}
}

function Controller:Apply()
	if not self.Enabled then return end

	Bloom.Intensity = self.Settings.Bloom.Intensity
	Bloom.Size = self.Settings.Bloom.Size
	Bloom.Threshold = self.Settings.Bloom.Threshold
	Bloom.Parent = Lighting

	Lighting.Ambient = self.Settings.Lighting.ShadowColor
	Lighting.OutdoorAmbient = self.Settings.Lighting.EnvironmentColor
	
	Lighting.GlobalShadows = self.Settings.Lighting.GlobalShadows
end

function Controller:Reset()
	Bloom.Parent = nil
	Lighting.Ambient = Defaults.Ambient
	Lighting.OutdoorAmbient = Defaults.OutdoorAmbient
	Lighting.GlobalShadows = Defaults.GlobalShadows
	Lighting.ColorShift_Top = Defaults.ColorShift_Top
	Lighting.ColorShift_Bottom = Defaults.ColorShift_Bottom
end

function Controller:UpdateBloom(intensity, size, threshold)
	if intensity then self.Settings.Bloom.Intensity = intensity end
	if size then self.Settings.Bloom.Size = size end
	if threshold then self.Settings.Bloom.Threshold = threshold end
	self:Apply()
end

function Controller:UpdateLighting(shadowColor, envColor, globalShadows)
	if shadowColor then self.Settings.Lighting.ShadowColor = shadowColor end
	if envColor then self.Settings.Lighting.EnvironmentColor = envColor end
	if globalShadows ~= nil then self.Settings.Lighting.GlobalShadows = globalShadows end
	self:Apply()
end

function Controller:Toggle(state)
	self.Enabled = state
	if state then
		self:Apply()
	else
		self:Reset()
	end
end

function Controller:Destroy()
	self:Toggle(false)
	Bloom:Destroy()
	_G[ControllerKey] = nil
end

_G[ControllerKey] = Controller
Controller:Toggle(true)
