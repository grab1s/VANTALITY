
local AuraController = {}
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local AuraRepository = {} 
local ActiveAuras = {} -- { ["Blackflash"] = true }

local function RemoveSpecificAura(auraName, character)
    if not character then return end
    
    for _, desc in pairs(character:GetDescendants()) do
        if desc:GetAttribute("VantalityAuraID") == auraName then
            desc:Destroy()
        end
    end
end

local function ApplySpecificAura(auraName, character)
    if not character then return end
    
    local constructor = AuraRepository[auraName]
    if not constructor then return end

    RemoveSpecificAura(auraName, character)

    task.spawn(function()
        pcall(function()
            constructor(character)
        end)
    end)
end

local function RefreshAll(character)
    if not character then return end
    local root = character:WaitForChild("HumanoidRootPart", 10)
    local ra = character:WaitForChild("Right Arm", 10)
    
    if not root or not ra then return end

    for auraName, isEnabled in pairs(ActiveAuras) do
        if isEnabled then
            ApplySpecificAura(auraName, character)
        end
    end
end

function AuraController:Init(repo)
    AuraRepository = repo
    
    if LocalPlayer.Character then
        task.spawn(function() RefreshAll(LocalPlayer.Character) end)
    end
    
    LocalPlayer.CharacterAdded:Connect(function(char)
        task.wait(0.6)
        RefreshAll(char)
    end)
end

function AuraController:ToggleAura(auraName, state)
    ActiveAuras[auraName] = state
    local char = LocalPlayer.Character
    if char then
        if state then
            ApplySpecificAura(auraName, char)
        else
            RemoveSpecificAura(auraName, char)
        end
    end
end

function AuraController:GetAuraNames()
    local t = {}
    for n,_ in pairs(AuraRepository) do table.insert(t, n) end
    table.sort(t)
    return t
end

return AuraController
