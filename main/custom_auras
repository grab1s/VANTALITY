
local AuraController = {}
local Players = game:GetService("Players")
local CollectionService = game:GetService("CollectionService")
local LocalPlayer = Players.LocalPlayer

local AuraRepository = {} 
local ActiveAuras = {} 

local TAG_ID = "Vantality_VFX_Object"

local function RemoveAura(auraName, character)
    local allTags = CollectionService:GetTagged(TAG_ID)
    for _, obj in pairs(allTags) do
        if obj:IsDescendantOf(character) and obj:GetAttribute("AuraName") == auraName then
            obj:Destroy()
        end
    end
end

local function ApplyAura(auraName, character)
    local constructor = AuraRepository[auraName]
    if not constructor then return end

    RemoveAura(auraName, character)

    local function Tagger(instance)
        if instance then
            CollectionService:AddTag(instance, TAG_ID)
            instance:SetAttribute("AuraName", auraName) -- Чтобы знать, чья это аура
        end
        return instance
    end

    task.spawn(function()
        pcall(function()
            constructor(character, Tagger)
        end)
    end)
end

local function Refresh(character)
    local root = character:WaitForChild("HumanoidRootPart", 10)
    if not root then return end
    
    task.wait(0.5)

    for name, enabled in pairs(ActiveAuras) do
        if enabled then
            ApplyAura(name, character)
        end
    end
end

function AuraController:Init(repo)
    AuraRepository = repo
    if LocalPlayer.Character then Refresh(LocalPlayer.Character) end
    LocalPlayer.CharacterAdded:Connect(Refresh)
end

function AuraController:ToggleAura(name, state)
    ActiveAuras[name] = state
    local char = LocalPlayer.Character
    if char then
        if state then
            ApplyAura(name, char)
        else
            RemoveAura(name, char)
        end
    end
end

function AuraController:GetAuraNames()
    local t = {}
    for n,_ in pairs(AuraRepository) do table.insert(t, n) end
    table.sort(t)
    return t
end

return AuraController
