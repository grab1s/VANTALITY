local Env = getgenv and getgenv() or _G

-- Полная очистка перед загрузкой (для хот-релоада)
if Env.LuauAPI then
    Env.LuauAPI:UnloadAll()
    Env.LuauAPI = nil
end

local LuauAPI = {}
Env.LuauAPI = LuauAPI

-- Настройка файловой системы
local FileSystem = {
    Root = "Vantality",
    Folder = "Vantality/scripts"
}

if not isfolder(FileSystem.Root) then makefolder(FileSystem.Root) end
if not isfolder(FileSystem.Folder) then makefolder(FileSystem.Folder) end

-- Состояние модуля
local State = {
    LoadedScripts = {},
    ColumnIndex = 0,
    Columns = {"Center", "Right"}, -- Используем для внутренней логики
    GUIColumns = {}, -- Сюда запишем реальные ScrollingFrame'ы
    Notifier = nil,
    TabRef = nil,
    ListBoxRef = nil
}

-- Утилиты
local function GetCleanName(path)
    return path:match("([^\\/]+)$")
end

local function GetFiles()
    local t = {}
    for _, p in pairs(listfiles(FileSystem.Folder)) do
        local n = GetCleanName(p)
        if n then table.insert(t, n) end
    end
    return t
end

-- Песочница для скриптов
local function CreateSandboxedEnv(scriptName)
    local UserEnv = setmetatable({}, {
        __index = function(self, key)
            -- Перехватываем обращение к Vantality
            if key == "Vantality" then return State.LoadedScripts[scriptName].API end
            -- Остальное берем из глобального окружения
            return Env[key] or getfenv()[key]
        end,
        __newindex = function(self, key, value)
            getfenv()[key] = value
        end
    })
    return UserEnv
end

-- Система поиска контейнеров (Fix для ошибки Tab.Root is nil)
local function ResolveContainers()
    -- Мы ищем контейнеры, отталкиваясь от нашего ListBox "SCRIPTS"
    -- Путь: TextLabel("SCRIPTS") -> ListBox -> Column(Left) -> MenuContainer -> [Left, Center, Right]
    
    local MainGui = Env.ahkgbs_instance and Env.ahkgbs_instance.Main
    if not MainGui then return false end

    for _, obj in pairs(MainGui:GetDescendants()) do
        if obj:IsA("TextLabel") and obj.Text == "SCRIPTS" and obj.Visible then
            local ListBoxFrame = obj.Parent
            if not ListBoxFrame then continue end
            
            local CurrentColumn = ListBoxFrame.Parent -- Это колонка "Left"
            if not CurrentColumn then continue end
            
            local MenuContainer = CurrentColumn.Parent
            if not MenuContainer then continue end
            
            -- Теперь ищем Center и Right среди детей MenuContainer
            -- В uiLIB колонки позиционируются по Scale X:
            -- Left ~ 0.175, Center ~ 0.5, Right ~ 0.825
            
            for _, col in pairs(MenuContainer:GetChildren()) do
                if col:IsA("ScrollingFrame") then
                    local x = col.Position.X.Scale
                    if math.abs(x - 0.5) < 0.05 then
                        State.GUIColumns["Center"] = col
                    elseif math.abs(x - 0.825) < 0.05 then
                        State.GUIColumns["Right"] = col
                    end
                end
            end
            
            if State.GUIColumns["Center"] and State.GUIColumns["Right"] then
                return true
            end
        end
    end
    return false
end

-- Основные методы
function LuauAPI:UnloadScript(name)
    local data = State.LoadedScripts[name]
    if not data then return end

    -- 1. Отключаем соединения
    if data.Connections then
        for _, conn in pairs(data.Connections) do
            if conn and conn.Connected then conn:Disconnect() end
        end
    end

    -- 2. Удаляем UI
    if data.SectionFrame and data.SectionFrame.Parent then
        data.SectionFrame:Destroy()
    end

    -- 3. Хук выгрузки
    if data.Env and data.Env.OnUnload and type(data.Env.OnUnload) == "function" then
        pcall(data.Env.OnUnload)
    end

    State.LoadedScripts[name] = nil
    State.ListBoxRef:Refresh()
end

function LuauAPI:UnloadAll()
    for name, _ in pairs(State.LoadedScripts) do
        self:UnloadScript(name)
    end
end

function LuauAPI:Execute(name, code)
    if State.LoadedScripts[name] then
        if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Script already running!", Icon="alert-circle"}) end
        return
    end

    local ScriptData = {
        Connections = {},
        SectionFrame = nil,
        SectionAPI = nil,
        Env = nil
    }

    local API_Proxy = {}
    
    function API_Proxy.CreateSection(title)
        if ScriptData.SectionAPI then return ScriptData.SectionAPI end
        
        -- Выбираем колонку (Center -> Right -> Center...)
        State.ColumnIndex = State.ColumnIndex + 1
        if State.ColumnIndex > #State.Columns then State.ColumnIndex = 1 end
        
        local colKey = State.Columns[State.ColumnIndex]
        local guiContainer = State.GUIColumns[colKey]
        
        if not guiContainer then
            -- Если контейнеры не найдены, пробуем найти их еще раз
            ResolveContainers()
            guiContainer = State.GUIColumns[colKey]
            
            if not guiContainer then
                warn("[Luau API] Critical: UI Container not found. Cannot create section.")
                return nil
            end
        end
        
        -- Хак для захвата GUI объекта: смотрим детей до и после создания
        local oldChildren = guiContainer:GetChildren()
        
        -- Создаем секцию через либу (она требует lowercase: 'center', 'right')
        local NewSectionAPI = State.TabRef:AddSection({
            Name = tostring(title),
            Position = colKey:lower()
        })
        
        -- Находим новый объект
        local newChildren = guiContainer:GetChildren()
        for _, child in pairs(newChildren) do
            local isNew = true
            for _, old in pairs(oldChildren) do
                if old == child then isNew = false break end
            end
            if isNew then
                ScriptData.SectionFrame = child
                break
            end
        end
        
        ScriptData.SectionAPI = NewSectionAPI
        return NewSectionAPI
    end

    function API_Proxy.Bind(signal, callback)
        local conn = signal:Connect(callback)
        table.insert(ScriptData.Connections, conn)
        return conn
    end

    function API_Proxy.Notify(cfg)
        if State.Notifier then State.Notifier:Notify(cfg) end
    end

    ScriptData.API = API_Proxy
    State.LoadedScripts[name] = ScriptData

    local func, err = loadstring(code, name)
    if not func then
        warn("[Vantality Luau] Syntax Error:", err)
        if State.Notifier then State.Notifier:Notify({Title="Error", Content="Syntax Error", Icon="alert-triangle"}) end
        State.LoadedScripts[name] = nil
        return
    end

    local Sandbox = CreateSandboxedEnv(name)
    setfenv(func, Sandbox)
    ScriptData.Env = Sandbox

    local s, r = pcall(func)
    if not s then
        warn("[Vantality Luau] Runtime Error:", r)
        if State.Notifier then State.Notifier:Notify({Title="Error", Content="Runtime Error (F9)", Icon="alert-circle"}) end
        self:UnloadScript(name)
    else
        if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Loaded: "..name, Icon="check"}) end
    end
end

function LuauAPI:Init(Tab, IgnoredSection, NotifierObj)
    State.TabRef = Tab
    State.Notifier = NotifierObj
    
    local SelectedFile = nil

    -- 1. Создаем ListBox (Якорь для поиска)
    State.ListBoxRef = Tab:AddListBox({
        Name = "SCRIPTS",
        Position = "left",
        Height = 350,
        Values = GetFiles(),
        Multi = false,
        Callback = function(val) SelectedFile = val end
    })

    -- 2. Пытаемся найти контейнеры (с задержкой, чтобы UI успел отрисоваться)
    task.delay(0.5, function()
        if not ResolveContainers() then
            warn("[Luau API] Warning: UI Containers not immediately found. Will retry on Execute.")
        end
    end)

    -- 3. Создаем кнопки управления
    local ControlSection = Tab:AddSection({
        Name = " ",
        Position = "left"
    })

    ControlSection:AddButton({
        Name = "Load Script",
        Callback = function()
            if not SelectedFile then return end
            local path = FileSystem.Folder .. "/" .. SelectedFile
            if isfile(path) then
                LuauAPI:Execute(SelectedFile, readfile(path))
            else
                if State.Notifier then State.Notifier:Notify({Title="Error", Content="File not found", Icon="x"}) end
                State.ListBoxRef:SetValues(GetFiles())
                State.ListBoxRef:Refresh()
            end
        end
    })

    ControlSection:AddButton({
        Name = "Unload Script",
        Callback = function()
            if not SelectedFile then return end
            if State.LoadedScripts[SelectedFile] then
                LuauAPI:UnloadScript(SelectedFile)
                if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Unloaded: "..SelectedFile, Icon="trash"}) end
            else
                if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Script is not loaded", Icon="info"}) end
            end
        end
    })

    ControlSection:AddButton({
        Name = "Refresh List",
        Callback = function()
            State.ListBoxRef:SetValues(GetFiles())
            State.ListBoxRef:Refresh()
            SelectedFile = nil
            if State.Notifier then State.Notifier:Notify({Title="Luau", Content="List Refreshed", Icon="refresh-cw"}) end
        end
    })

    ControlSection:AddButton({
        Name = "Delete File",
        Risky = true,
        Callback = function()
            if SelectedFile then
                local path = FileSystem.Folder .. "/" .. SelectedFile
                if isfile(path) then
                    delfile(path)
                    State.ListBoxRef:SetValues(GetFiles())
                    State.ListBoxRef:Refresh()
                    local cachedName = SelectedFile
                    SelectedFile = nil
                    self:UnloadScript(cachedName)
                    if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Deleted: "..cachedName, Icon="trash-2"}) end
                end
            end
        end
    })
end

return LuauAPI
