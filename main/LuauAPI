local Env = getgenv and getgenv() or _G

if Env.LuauAPI then
    Env.LuauAPI:UnloadAll()
    Env.LuauAPI = nil
end

local LuauAPI = {}
Env.LuauAPI = LuauAPI

local HttpService = game:GetService("HttpService")

local FileSystem = {
    Root = "Vantality",
    Scripts = "Vantality/scripts",
    Configs = "Vantality/scripts/configs"
}

if not isfolder(FileSystem.Root) then makefolder(FileSystem.Root) end
if not isfolder(FileSystem.Scripts) then makefolder(FileSystem.Scripts) end
if not isfolder(FileSystem.Configs) then makefolder(FileSystem.Configs) end

local State = {
    LoadedScripts = {},
    ColumnIndex = 0,
    Columns = {"Center", "Right"},
    GUIColumns = {}, 
    Notifier = nil,
    TabRef = nil,
    ListBoxRef = nil
}

local function GetCleanName(path)
    return path:match("([^\\/]+)$")
end

local function GetFiles()
    local t = {}
    for _, p in pairs(listfiles(FileSystem.Scripts)) do
        local n = GetCleanName(p)
        if n and n ~= "configs" then table.insert(t, n) end
    end
    return t
end

local function ResolveContainers()
    local MainGui = Env.ahkgbs_instance and Env.ahkgbs_instance.Main
    if not MainGui then return false end

    for _, obj in pairs(MainGui:GetDescendants()) do
        if obj:IsA("TextLabel") and obj.Text == "SCRIPTS" and obj.Visible then
            local ListBoxFrame = obj.Parent
            if not ListBoxFrame then continue end
            
            local CurrentColumn = ListBoxFrame.Parent
            if not CurrentColumn then continue end
            
            local MenuContainer = CurrentColumn.Parent
            if not MenuContainer then continue end
            
            for _, col in pairs(MenuContainer:GetChildren()) do
                if col:IsA("ScrollingFrame") then
                    local x = col.Position.X.Scale
                    if math.abs(x - 0.5) < 0.05 then
                        State.GUIColumns["Center"] = col
                    elseif math.abs(x - 0.825) < 0.05 then
                        State.GUIColumns["Right"] = col
                    end
                end
            end
            
            if State.GUIColumns["Center"] and State.GUIColumns["Right"] then
                return true
            end
        end
    end
    return false
end

local function CreateSandboxedEnv(scriptName)
    local UserEnv = setmetatable({}, {
        __index = function(self, key)
            if key == "Vantality" then return State.LoadedScripts[scriptName].API end
            return Env[key] or getfenv()[key]
        end,
        __newindex = function(self, key, value)
            getfenv()[key] = value
        end
    })
    return UserEnv
end

local function SaveScriptConfig(name)
    local data = State.LoadedScripts[name]
    if not data or not data.ConfigRegistry then return end

    local cfgToSave = {}
    for key, element in pairs(data.ConfigRegistry) do
        if element.GetValue then
            cfgToSave[key] = element:GetValue()
        end
    end

    local success, json = pcall(HttpService.JSONEncode, HttpService, cfgToSave)
    if success then
        writefile(FileSystem.Configs .. "/" .. name, json)
    end
end

local function LoadScriptConfig(name)
    local path = FileSystem.Configs .. "/" .. name
    if isfile(path) then
        local content = readfile(path)
        local success, decoded = pcall(HttpService.JSONDecode, HttpService, content)
        if success and type(decoded) == "table" then
            return decoded
        end
    end
    return {}
end

function LuauAPI:UnloadScript(name)
    local data = State.LoadedScripts[name]
    if not data then return end

    pcall(SaveScriptConfig, name)

    if data.Connections then
        for _, conn in pairs(data.Connections) do
            if conn and conn.Connected then conn:Disconnect() end
        end
    end

    if data.SectionFrame and data.SectionFrame.Parent then
        data.SectionFrame:Destroy()
    end

    if data.Env and data.Env.OnUnload and type(data.Env.OnUnload) == "function" then
        pcall(data.Env.OnUnload)
    end

    State.LoadedScripts[name] = nil
    State.ListBoxRef:Refresh()
end

function LuauAPI:UnloadAll()
    for name, _ in pairs(State.LoadedScripts) do
        self:UnloadScript(name)
    end
end

function LuauAPI:Execute(name, code)
    if State.LoadedScripts[name] then
        if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Script already running!", Icon="alert-circle"}) end
        return
    end

    local LoadedConfig = LoadScriptConfig(name)

    local ScriptData = {
        Connections = {},
        SectionFrame = nil,
        ConfigRegistry = {}, 
        Env = nil
    }

    local API_Proxy = {}
    
    function API_Proxy.CreateSection(title)
        State.ColumnIndex = State.ColumnIndex + 1
        if State.ColumnIndex > #State.Columns then State.ColumnIndex = 1 end
        
        local colKey = State.Columns[State.ColumnIndex]
        local guiContainer = State.GUIColumns[colKey]
        
        if not guiContainer then
            ResolveContainers()
            guiContainer = State.GUIColumns[colKey]
            if not guiContainer then return nil end
        end
        
        local oldChildren = guiContainer:GetChildren()
        
        local RealSection = State.TabRef:AddSection({
            Name = tostring(title),
            Position = colKey:lower()
        })
        
        local newChildren = guiContainer:GetChildren()
        for _, child in pairs(newChildren) do
            local isNew = true
            for _, old in pairs(oldChildren) do
                if old == child then isNew = false break end
            end
            if isNew then
                ScriptData.SectionFrame = child
                break
            end
        end
        
        local SectionProxy = {}
        
        local function WrapElement(funcName, config)
            local key = config.Flag or config.Name
            
            if LoadedConfig[key] ~= nil then
                config.Default = LoadedConfig[key]
            end
            
            local Element = RealSection[funcName](RealSection, config)
            
            if Element and key then
                ScriptData.ConfigRegistry[key] = Element
            end
            
            return Element
        end

        function SectionProxy:AddToggle(cfg) return WrapElement("AddToggle", cfg) end
        function SectionProxy:AddSlider(cfg) return WrapElement("AddSlider", cfg) end
        function SectionProxy:AddDropdown(cfg) return WrapElement("AddDropdown", cfg) end
        function SectionProxy:AddColorPicker(cfg) return WrapElement("AddColorPicker", cfg) end
        function SectionProxy:AddKeybind(cfg) return WrapElement("AddKeybind", cfg) end
        function SectionProxy:AddInput(cfg) return WrapElement("AddInput", cfg) end
        
        function SectionProxy:AddButton(cfg) return RealSection:AddButton(cfg) end
        function SectionProxy:AddParagraph(cfg) return RealSection:AddParagraph(cfg) end

        return SectionProxy
    end

    function API_Proxy.Bind(signal, callback)
        local conn = signal:Connect(callback)
        table.insert(ScriptData.Connections, conn)
        return conn
    end

    function API_Proxy.Notify(cfg)
        if State.Notifier then State.Notifier:Notify(cfg) end
    end

    State.LoadedScripts[name] = ScriptData

    local func, err = loadstring(code, name)
    if not func then
        warn("[Vantality Luau] Syntax Error:", err)
        if State.Notifier then State.Notifier:Notify({Title="Error", Content="Syntax Error", Icon="alert-triangle"}) end
        State.LoadedScripts[name] = nil
        return
    end

    local Sandbox = CreateSandboxedEnv(name)
    setfenv(func, Sandbox)
    ScriptData.Env = Sandbox

    local s, r = pcall(func)
    if not s then
        warn("[Vantality Luau] Runtime Error:", r)
        if State.Notifier then State.Notifier:Notify({Title="Error", Content="Runtime Error (F9)", Icon="alert-circle"}) end
        self:UnloadScript(name)
    else
        if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Loaded: "..name, Icon="check"}) end
    end
end

function LuauAPI:Init(Tab, IgnoredSection, NotifierObj)
    State.TabRef = Tab
    State.Notifier = NotifierObj
    
    if Tab.Root then
        State.GUIColumns["Center"] = Tab.Root:FindFirstChild("Center")
        State.GUIColumns["Right"]  = Tab.Root:FindFirstChild("Right")
    end
    
    local SelectedFile = nil

    State.ListBoxRef = Tab:AddListBox({
        Name = "SCRIPTS",
        Position = "left",
        Height = 350,
        Values = GetFiles(),
        Multi = false,
        Callback = function(val) SelectedFile = val end
    })

    task.delay(0.5, function() ResolveContainers() end)

    local ControlSection = Tab:AddSection({
        Name = " ",
        Position = "left"
    })

    ControlSection:AddButton({
        Name = "Load Script",
        Callback = function()
            if not SelectedFile then return end
            local path = FileSystem.Scripts .. "/" .. SelectedFile
            if isfile(path) then
                LuauAPI:Execute(SelectedFile, readfile(path))
            else
                if State.Notifier then State.Notifier:Notify({Title="Error", Content="File not found", Icon="x"}) end
                State.ListBoxRef:SetValues(GetFiles())
                State.ListBoxRef:Refresh()
            end
        end
    })

    ControlSection:AddButton({
        Name = "Unload Script",
        Callback = function()
            if not SelectedFile then return end
            if State.LoadedScripts[SelectedFile] then
                LuauAPI:UnloadScript(SelectedFile)
                if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Unloaded: "..SelectedFile, Icon="trash"}) end
            else
                if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Script is not loaded", Icon="info"}) end
            end
        end
    })

    ControlSection:AddButton({
        Name = "Refresh List",
        Callback = function()
            State.ListBoxRef:SetValues(GetFiles())
            State.ListBoxRef:Refresh()
            SelectedFile = nil
            if State.Notifier then State.Notifier:Notify({Title="Luau", Content="List Refreshed", Icon="refresh-cw"}) end
        end
    })

    ControlSection:AddButton({
        Name = "Delete File",
        Risky = true,
        Callback = function()
            if SelectedFile then
                local path = FileSystem.Scripts .. "/" .. SelectedFile
                if isfile(path) then
                    delfile(path)
                    State.ListBoxRef:SetValues(GetFiles())
                    State.ListBoxRef:Refresh()
                    local cachedName = SelectedFile
                    SelectedFile = nil
                    self:UnloadScript(cachedName)
                    if State.Notifier then State.Notifier:Notify({Title="Luau", Content="Deleted: "..cachedName, Icon="trash-2"}) end
                end
            end
        end
    })
end

return LuauAPI
